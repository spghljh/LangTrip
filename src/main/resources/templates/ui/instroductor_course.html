<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ê°•ì˜ì‹¤</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/instroductor_lecture.css}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</head>
<body>
    <!-- ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€ -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
        â˜°
    </button>

    <!-- ëª¨ë°”ì¼ ì˜¤ë²„ë ˆì´ -->
    <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>

    <div class="container-fluid">
        <div class="row">
            <!-- ì‚¬ì´ë“œë°” -->
            <div class="sidebar" id="sidebar">
                <a href="#" class="active">ğŸ“š í•™ìŠµ</a>
                <a href="#">ğŸ§  í€´ì¦ˆ</a>
                <a href="#">ğŸ‘¤ ë§ˆì´í˜ì´ì§€</a>
                <a href="#">ğŸ“‚ ë” ë³´ê¸°</a>
                <a href="#">ğŸ« ë‚´ ê°•ì˜ì‹¤</a>
            </div>

            <!-- ë©”ì¸ ì½˜í…ì¸  -->
            <div class="main-content">
                <div class="lecture-section">
                    <h1 class="main-title">ë‚´ ê°•ì˜ì‹¤</h1>
                    
                    <!-- ê°•ì˜ ë“±ë¡ í¼ -->
<form id="lecture-register" enctype="multipart/form-data">
<div class="lecture-form">
    <div class="form-row">
        <div class="form-group">
            <label for="category">ì¹´í…Œê³ ë¦¬</label>
            <select id="category" name="category" class="form-control">
                <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                <option value="ì˜ì–´">ì˜ì–´</option>
                <option value="ì¼ë³¸ì–´">ì¼ë³¸ì–´</option>
                <option value="ì¤‘êµ­ì–´">ì¤‘êµ­ì–´</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="level">ë‚œì´ë„</label>
            <select id="level" name="difficulty" class="form-control">
                <option value="">ë‚œì´ë„ ì„ íƒ</option>
                <option value="ì´ˆê¸‰">ì´ˆê¸‰</option>
                <option value="ì¤‘ê¸‰">ì¤‘ê¸‰</option>
                <option value="ê³ ê¸‰">ê³ ê¸‰</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="courseTitle">ê°•ì˜ëª…</label>
            <input type="text" name="courseTitle" id="courseTitle" class="form-control" placeholder="ê°•ì˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>

    </div>
        <!-- ì¸ë„¤ì¼ ì—…ë¡œë“œ -->
        <div class="form-group thumnail-group">
            <label for="thumbnail">ì¸ë„¤ì¼ ì´ë¯¸ì§€</label>
            <input type="file" name="thumbnail" id="thumbnail" class="form-control" accept="image/*">
        </div>
    
    <div class="form-group description-group">
        <label for="description">ê°•ì˜ ì„¤ëª…</label>
        <textarea id="description" name="introduction" class="form-control" rows="3" placeholder="ê°•ì˜ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    </div>
    
    <button type="button" class="btn-register" id="lectureBtn" onclick="registerLecture()">ê°•ì˜ ë“±ë¡</button>
</div>
</form>         
        <div class="lecture-list" id="lectureList">
        
        </div>
        <div class="pagination" id="pagination" style="text-align:center; margin-top:20px;"></div>
        
        
         <div class="lecture-empty" id="lectureEmpty">
                        ê°•ì˜ì‹¤ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.<br>
                        ìƒˆë¡œìš´ ê°•ì˜ë¥¼ ë“±ë¡í•´ë³´ì„¸ìš”!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í”„ë¡œí•„ ìºë¦­í„° (ì±—ë´‡ ë²„íŠ¼) -->
    <div class="profile-icon" onclick="toggleChatbot()">
        <img src="/images/mascot2.png" alt="ë§ˆìŠ¤ì½”íŠ¸" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiM0YTkwZTIiLz4KPHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iMzAiIHZpZXdCb3g9IjAgMCAzMCAzMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTUiIGN5PSIxNSIgcj0iMTUiIGZpbGw9IndoaXRlIi8+CjxjaXJjbGUgY3g9IjEwIiBjeT0iMTIiIHI9IjIiIGZpbGw9IiMzMzMiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMiIgZmlsbD0iIzMzMyIvPgo8cGF0aCBkPSJNMTAgMjBRMTUgMjUgMjAgMjAiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+Cjwvc3ZnPgo8L3N2Zz4K'">
    </div>

    <!-- ì±—ë´‡ ëª¨ë‹¬ -->
    <div class="chatbot-modal" id="chatbotModal">
        <div class="chatbot-container">
            <div class="chatbot-header">
                <h4>ğŸ¤– í•™ìŠµ ë„ìš°ë¯¸</h4>
                <button class="chatbot-close" onclick="toggleChatbot()">Ã—</button>
            </div>
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="message bot">
                    ì•ˆë…•í•˜ì„¸ìš”! í•™ìŠµ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
                </div>
            </div>
            <div class="chatbot-input">
                <div class="chatbot-input-group">
                    <input type="text" id="chatbotInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleChatbotEnter(event)">
                    <button class="chatbot-send" onclick="sendChatbotMessage()">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function toggleChatbot() {
            const modal = document.getElementById('chatbotModal');
            modal.classList.toggle('active');
        }

        function sendChatbotMessage() {
            const input = document.getElementById('chatbotInput');
            const messages = document.getElementById('chatbotMessages');
            const message = input.value.trim();
            
            if (message) {
                // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
                const userMessage = document.createElement('div');
                userMessage.className = 'message user';
                userMessage.textContent = message;
                messages.appendChild(userMessage);
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                input.value = '';
                
                // ì±—ë´‡ ì‘ë‹µ ì‹œë®¬ë ˆì´ì…˜
//                 setTimeout(() => {
//                     const botResponse = document.createElement('div');
//                     botResponse.className = 'message bot';
//                     botResponse.textContent = getBotResponse(message);
//                     messages.appendChild(botResponse);
                    
//                     // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
//                     messages.scrollTop = messages.scrollHeight;
//                 }, 1000);
                axios.post("/api/chat", message, {
                	headers:{
                		"Content-Type" : "text/plain"
                	}
                }).
                then(res=>{
				const botResponse = document.createElement('div');
				botResponse.className = 'message bot';
				botResponse.textContent = res.data;
				messages.scrollTop = messages.scrollHeight;
				messages.appendChild(botResponse);
                // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
                messages.scrollTop = messages.scrollHeight;
                	
                })
                .catch(err=>{
                	const errorMsg = document.createElement('div');
                    errorMsg.className = 'message bot';
                    errorMsg.textContent = "ì˜¤ë¥˜ ë°œìƒ: " + err;
                    messages.appendChild(errorMsg);
                });
                
            }
        }

//         function getBotResponse(message) {
//             const responses = [
//                 "ê°•ì˜ ê´€ë ¨ ì§ˆë¬¸ì´ì‹œêµ°ìš”! ë” ìì„¸íˆ ì•Œë ¤ì£¼ì‹œë©´ ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆì–´ìš”.",
//                 "ì¢‹ì€ ì§ˆë¬¸ì´ë„¤ìš”. í•™ìŠµì— ë„ì›€ì´ ë˜ëŠ” ì •ë³´ë¥¼ ì°¾ì•„ë“œë¦´ê²Œìš”.",
//                 "ê°•ì˜ì‹¤ ì‚¬ìš©ë²•ì— ëŒ€í•´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”? ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”!",
//                 "í•™ìŠµ ì§„ë„ë‚˜ í€´ì¦ˆì— ëŒ€í•œ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”.",
//                 "ì˜ìƒ ì—…ë¡œë“œë‚˜ ê°•ì˜ ë“±ë¡ì— ëŒ€í•´ ë„ì›€ì´ í•„ìš”í•˜ì‹œë©´ ì•ˆë‚´í•´ë“œë¦´ê²Œìš”."
//             ];
//             return responses[Math.floor(Math.random() * responses.length)];
//         }

        function handleChatbotEnter(event) {
            if (event.key === 'Enter') {
                sendChatbotMessage();
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('chatbotModal').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleChatbot();
            }
        });

        // ì‚¬ì´ë“œë°” ë§í¬ í™œì„±í™”
        document.querySelectorAll('.sidebar a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
                this.classList.add('active');
                
                // ëª¨ë°”ì¼ì—ì„œ ë©”ë‰´ í´ë¦­ ì‹œ ì‚¬ì´ë“œë°” ë‹«ê¸°
                if (window.innerWidth <= 768) {
                    toggleMobileMenu();
                }
            });
        });

        // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì‚¬ì´ë“œë°” ìƒíƒœ ì´ˆê¸°í™”
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.querySelector('.mobile-overlay').classList.remove('active');
            }
        });
    </script>
   
    
<!--     ê°•ì˜ë“±ë¡ í˜ì´ì§€ë„¤ì´ì…˜ ê¸°ëŠ¥  -->
   	<script>
   	let currentPage = 1;
   	const limit = 5;
   	window.addEventListener("DOMContentLoaded", () => loadMyCourse(1));
    async function loadMyCourse(page = 1){
	const empty = document.getElementById("lectureEmpty");   
	 const list = document.getElementById("lectureList");
	 currentPage = page;
   		list.innerHTML = "";
   		if(empty){
   			empty.style.display="none";
   		}
    	try{
    		const res = await axios.get(`/ui/my_lecture?page=${page}&limit=${limit}`);
    		const courseListData = res.data.courseList;
    		const totalCount = res.data.totalCount;
    		
    		  if (!courseListData || courseListData.length === 0) {
    	            if (empty) empty.style.display = "block";
    	            return;
    	        }
    		
    		
    		for(const courseList of courseListData){
    			appendLectureForm(courseList);
    		}
    		
    		getPagination(totalCount, page, limit);
    		
    	}catch(err){
    		console.error(err);
    		alert("ê°•ì˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
    	}
    	
    }

   	async function registerLecture(){
   		const form = document.getElementById("lecture-register");
   		const formData = new FormData(form);
   		const empty = document.getElementById("lectureEmpty");   
   		
   		if(empty){
   			empty.style.display="none";
   		}
   		
   		try{
   			const res= await axios.post('/ui/instroductor_course', formData);
   			
   			alert("ê°•ì˜ ë“±ë¡ ì™„ë£Œ : "+res.data.msg);
   			const courseData = res.data.courseData;
   			console.log(res.data);
   			
   		 const countRes = await axios.get('/ui/my_lecture?page=1&limit=5');
         const totalCount = countRes.data.totalCount;

         // 3. ë§ˆì§€ë§‰ í˜ì´ì§€ ê³„ì‚°
         const lastPage = Math.ceil(totalCount / limit);

         // 4. í˜„ì¬ í˜ì´ì§€ì— ì—¬ìœ ê°€ ìˆëŠ”ì§€ í™•ì¸
         const currentCardCount = document.querySelectorAll(".lecture-card").length;

         if (currentCardCount < limit) {
             // ì§€ê¸ˆ í˜ì´ì§€ì— ì—¬ìœ  ìˆìŒ â†’ UIì— ë°”ë¡œ ì¶”ê°€
             const courseData = res.data.courseData;
             appendLectureForm(courseData);
         } else {
             // ì§€ê¸ˆ í˜ì´ì§€ ê½‰ì°¸ â†’ ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™
             loadMyCourse(lastPage);
         }
   			
   			
   			form.reset();//í¼ì´ˆê¸°í™”
   		}catch(err){
   			console.error(err);
   	      	alert("ê°•ì˜ ë“±ë¡ ì‹¤íŒ¨");
   		}
   	}
   
function appendLectureForm(course){
	const list = document.getElementById("lectureList");
// 	const safePath = course.thumbnailPath.replace(/ /g, '%20'); // ê³µë°±ë§Œ ì¸ì½”ë”©
	const card = document.createElement("div");
	const lastIndex = course.thumbnailPath.lastIndexOf("/");
	const base = course.thumbnailPath.substring(0, lastIndex+1);
	const safePath = base + encodeURIComponent(course.thumbnailName);
	
	card.className="lecture-card";
	card.id = `course-${course.courseSeq}`;
	card.innerHTML= `
		  <img src="${safePath}" alt="ì¸ë„¤ì¼" class="lecture-img">
        <div class="lecture-content">
            <div class="lecture-info">
                <div class="lecture-title">
                    <span class="difficulty-badge difficulty-${course.difficulty}">${course.difficulty}</span>
                    <span class="language-badge language-${course.category}">${course.category}</span>
                    ${course.courseTitle}
                </div>
                <div class="lecture-meta">
                    <div class="lecture-count">ì»¨í…ì¸  ê°œìˆ˜ 5/7</div>
                    <div class="lecture-stats">
                        <div class="stat-item">
                            <span class="stat-icon">ğŸ‘¥</span>
                            <span>1,234ëª…</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-icon">â­</span>
                            <span>4.8</span>
                        </div>
                    </div>
                </div>
                <div class="lecture-description">${course.introduction || 'ê°•ì˜ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="goToCourse('${course.courseSeq}')">ê°•ì˜ ì´ë™</button>
                <button class="btn btn-secondary" onclick='goToCourseEdit(${JSON.stringify(course)})'>ê°•ì˜ ìˆ˜ì •</button>
                <button type="button" class="btn btn-danger" onclick="deleteCourse('${course.courseSeq}')">ê°•ì˜ ì‚­ì œ</button>
            </div>
        </div>
        `
;	
	list.append(card);
	
}
function deleteCourse(courseSeq){
	  if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
	axios.post("/upload/delete_course?seq="+courseSeq)
	.then(res=>{
		if(res.data=="success"){
			
		alert("ì‚­ì œ ì„±ê³µ");
		const card = document.getElementById(`course-${courseSeq}`);
        if (card) card.remove();
		}else{
			alert("ì‚­ì œ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
		}
	})
	.catch(err=>{
		alert("ì‚­ì œ ì‹¤íŒ¨");
		console.log(err);
	});
	
	
	
}
function goToCourse(courseSeq){
	location.href="/upload/upload_course?seq="+courseSeq;
}

function goToCourseEdit(course) {
	  axios.post("/upload/storeCourseSession", course, {
	    headers: { "Content-Type": "application/json" }
	  })
	  .then(() => {
	    location.href = "/upload/upload_update";
	  })
	  .catch(err => {
	    alert("ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨");
	  });
	}

function getPagination(totalCount, currentPage, limit) {
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    const totalPages = Math.ceil(totalCount / limit);
    const maxButtons = 5;

    // í˜„ì¬ í˜ì´ì§€ê°€ í¬í•¨ëœ ë¸”ë¡ ê³„ì‚°
    const currentBlock = Math.floor((currentPage - 1) / maxButtons);
    const startPage = currentBlock * maxButtons + 1;
    const endPage = Math.min(startPage + maxButtons - 1, totalPages);

    // ì´ì „ ë¸”ë¡ ë²„íŠ¼
    if (startPage > 1) {
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "<";
        prevBtn.className = "btn btn-sm btn-outline-secondary m-1";
        prevBtn.addEventListener("click", () => {
            loadMyCourse(startPage - 1);
        });
        pagination.appendChild(prevBtn);
    }

    // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
    for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement("button");
        btn.className = "btn btn-sm btn-outline-primary m-1";
        btn.textContent = i;

        if (i === currentPage) {
            btn.classList.add("active");
        }

        btn.addEventListener("click", () => {
            loadMyCourse(i);
        });

        pagination.appendChild(btn);
    }

    // ë‹¤ìŒ ë¸”ë¡ ë²„íŠ¼
    if (endPage < totalPages) {
        const nextBtn = document.createElement("button");
        nextBtn.textContent = ">";
        nextBtn.className = "btn btn-sm btn-outline-secondary m-1";
        nextBtn.addEventListener("click", () => {
            loadMyCourse(endPage + 1);
        });
        pagination.appendChild(nextBtn);
    }
}
   	
   	</script>
    
</body>
</html>