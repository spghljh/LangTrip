<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f5f5f5; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .reset-password-container { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); padding: 60px 40px; width: 100%; max-width: 400px; text-align: center; }
        .reset-password-title { font-size: 24px; font-weight: 600; color: #333; margin-bottom: 20px; }
        .reset-password-description { color: #666; font-size: 16px; line-height: 1.5; margin-bottom: 40px; }
        .form-group { margin-bottom: 25px; text-align: left; }
        .form-label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px; }
        .form-control { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease; background-color: #f8f9fa; }
        .form-control:focus { outline: none; border-color: #1DA1F2; box-shadow: 0 0 0 3px rgba(29, 161, 242, 0.1); background-color: white; }
        .password-field { position: relative; }
        .password-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #666; }
        .submit-button { width: 100%; padding: 15px; background: #1DA1F2; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease; margin-bottom: 20px; }
        .submit-button:disabled { background: #ccc; cursor: not-allowed; }
        .msg { font-size: 13px; margin-top: 5px; display: block; }
        .error-message, .success-message { font-size: 14px; margin-top: 15px; padding: 12px; border-radius: 6px; display: none; }
        .error-message { color: #dc3545; background: #f8d7da; border: 1px solid #f5c6cb; }
        .success-message { color: #28a745; background: #d4edda; border: 1px solid #c3e6cb; }
        .message.show { display: block; }
    </style>
</head>
<body>
    <div class="reset-password-container">
        <h1 class="reset-password-title">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</h1>
        <p class="reset-password-description">
            ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.<br>
            ì´ì „ì— ì‚¬ìš©í•œ ì  ì—†ëŠ” ë¹„ë°€ë²ˆí˜¸ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
        
        <form id="reset-password-form">
            <input type="hidden" id="userId" value="" />
            <div class="form-group">
                <label for="new-password" class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                <div class="password-field">
                    <input type="password" id="new-password" class="form-control" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                    <span class="password-toggle" onclick="togglePassword(this)">ğŸ‘</span>
                </div>
                <span id="password-msg" class="msg"></span>
            </div>
            <div class="form-group">
                <label for="confirm-password" class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <div class="password-field">
                    <input type="password" id="confirm-password" class="form-control" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" required>
                    <span class="password-toggle" onclick="togglePassword(this)">ğŸ‘</span>
                </div>
                <span id="password-check-msg" class="msg"></span>
            </div>
            
            <button type="submit" class="submit-button" id="submit-btn">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
            
            <div class="error-message message" id="error-message"></div>
        </form>
    </div>

    <script>
    function togglePassword(element) {
        const input = element.previousElementSibling;
        if (input.type === 'password') {
            input.type = 'text';
            element.textContent = 'ğŸ‘â€ğŸ—¨';
        } else {
            input.type = 'password';
            element.textContent = 'ğŸ‘';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        fetch("/api/auth/user/current-id", {
            credentials: "include"
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('userId').value = data.data;
            } else {
                showError(data.message || 'ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            console.error('Fetch Error:', error);
        });
    });

    document.getElementById('new-password').addEventListener('input', function () {
        const msg = document.getElementById('password-msg');
        const val = this.value;
        const regex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#$%^&*()_\-+=]).{8,20}$/;
        
        if (val.includes(' ')) {
            msg.textContent = "ë¹„ë°€ë²ˆí˜¸ì— ê³µë°±ì„ í¬í•¨í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            msg.style.color = "red";
        } else if (!regex.test(val)) {
            msg.textContent = "ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨ 8~20ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
            msg.style.color = "red";
        } else {
            msg.textContent = "";
        }
    });

    document.getElementById('confirm-password').addEventListener('input', function () {
        const pwd = document.getElementById('new-password').value;
        const confirmPwd = this.value;
        const msg = document.getElementById('password-check-msg');
        if (pwd && confirmPwd && pwd !== confirmPwd) {
            msg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
            msg.style.color = "red";
        } else {
            msg.textContent = "";
        }
    });

    document.getElementById('reset-password-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const submitBtn = document.getElementById('submit-btn');
        const userId = document.getElementById('userId').value;
        const pwdMsg = document.getElementById('password-msg').textContent;
        const pwdCheckMsg = document.getElementById('password-check-msg').textContent;

        if (!userId) {
            showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (pwdMsg || pwdCheckMsg) {
            showError('ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (newPassword !== confirmPassword) {
            showError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
        }

        submitBtn.disabled = true;
        hideMessages();

        fetch("/api/auth/password/reset", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            credentials: "include",
            body: JSON.stringify({
                userId: userId,
                newPassword: newPassword
            })
        })
        .then(response => response.json().then(data => ({ ok: response.ok, data })))
        .then(({ ok, data }) => {
            if (ok) {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.href = '/user/login';
            } else {
                showError(data.message || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            showError('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            console.error('Fetch Error:', error);
        })
        .finally(() => {
            submitBtn.disabled = false;
        });
    });

    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.classList.add('show');
    }

    function hideMessages() {
        const errorDiv = document.getElementById('error-message');
        errorDiv.classList.remove('show');
    }

    document.getElementById('new-password').addEventListener('focus', hideMessages);
    document.getElementById('confirm-password').addEventListener('focus', hideMessages);

    </script>
</body>
</html>