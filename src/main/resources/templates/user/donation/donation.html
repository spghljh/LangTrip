<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê°•ì˜ í›„ì›í•˜ê¸°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" th:href="@{/css/donation.css}">
</head>
<body>
<div class="sponsorship-modal">
    <div class="modal-header">
        <h2>ê°•ì˜ í›„ì›í•˜ê¸°</h2>
        <p>ì†Œì¤‘í•œ ë§ˆìŒì„ ì „í•´ë³´ì„¸ìš”</p>
        <button class="close-btn" onclick="closeModal()">&times;</button>
    </div>

    <div class="sponsorship-content">
        <!-- ê°•ì˜ ì •ë³´ -->
        <div class="lecture-info">
            <div class="lecture-title" th:text="${lecture.courseTitle}">í…ŒìŠ¤íŠ¸ ê°•ì˜ ì œëª©</div>
            <div class="instructor-name" th:text="${lecture.instructorNickname} + ' ê°•ì‚¬ë‹˜'">í™ê¸¸ë™ ê°•ì‚¬ë‹˜</div>
        </div>

        <!-- ì‚¬ìš©ì ë§ˆì¼ ì •ë³´ -->
        <div class="user-mile-info">
           <button class="charge-btn" onclick="chargeMiles()">ë§ˆì¼ ì¶©ì „í•˜ê¸°</button>
            <h3>ë³´ìœ  ë§ˆì¼</h3>
            <div class="current-miles" th:text="${#numbers.formatInteger(userMiles, 0, 'COMMA')}">15,000</div>
            <div class="miles-unit">ë§ˆì¼</div>
        </div>

        <!-- í›„ì› ê¸ˆì•¡ ì…ë ¥ -->
        <div class="amount-section">
            <div class="section-title">í›„ì› ê¸ˆì•¡</div>
            <div class="amount-input-group" id="amountInputGroup">
                <input type="number" id="amountInput" class="amount-input" placeholder="í›„ì›í•  ë§ˆì¼ ì…ë ¥"
                       min="100" th:max="${userMiles}" 
                       oninput="updateAmount()" 
                       onfocus="this.parentElement.classList.add('focused')" 
                       onblur="this.parentElement.classList.remove('focused')">
                <span class="miles-label">ë§ˆì¼</span>
                <div class="amount-controls">
                    <button class="amount-btn" onclick="decreaseAmount()">-</button>
                    <button class="amount-btn" onclick="increaseAmount()">+</button>
                </div>
            </div>
            <div class="error-message" id="errorMessage">í›„ì› ê¸ˆì•¡ì€ 100ë§ˆì¼ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
            <div class="preset-amounts">
                <button class="preset-btn" onclick="setAmount(1000)">1,000</button>
                <button class="preset-btn" onclick="setAmount(3000)">3,000</button>
                <button class="preset-btn" onclick="setAmount(5000)">5,000</button>
                <button class="preset-btn" onclick="setAmount(10000)">10,000</button>
                <button class="preset-btn" onclick="setAmount(20000)">20,000</button>
                <button class="preset-btn" onclick="setAmount('ì „ì•¡')">ì „ì•¡</button>
            </div>
        </div>

        <!-- í›„ì› ë©”ì‹œì§€ -->
        <div class="message-section" id="messageSection">
            <div class="section-title">í›„ì› ë©”ì‹œì§€</div>
            <div class="message-info" id="messageInfo">
                <span class="highlight">3,000ë§ˆì¼ ì´ìƒ</span> í›„ì› ì‹œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.
            </div>
            <textarea id="messageTextarea" class="message-textarea" maxlength="200" disabled
                      placeholder="ê°•ì‚¬ë‹˜ê»˜ ì „í•˜ê³  ì‹¶ì€ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”..." oninput="updateMessageCounter()"></textarea>
            <div class="message-counter"><span id="messageCount">0</span> / 200</div>
        </div>

        <!-- í›„ì› ë²„íŠ¼ -->
        <button id="sponsorshipBtn" class="sponsorship-btn" onclick="processSponsor()" disabled>
            <span id="sponsorshipBtnText">í›„ì›í•˜ê¸°</span>
        </button>

        <!-- ì•ˆë‚´ì‚¬í•­ -->
        <div class="notice">
            <strong>ğŸ’¡ í›„ì› ì•ˆë‚´</strong>
            <ul>
                <li>í›„ì›ëœ ë§ˆì¼ì€ ì¦‰ì‹œ ê°•ì‚¬ë‹˜ê»˜ ì „ë‹¬ë©ë‹ˆë‹¤</li>
                <li>í›„ì› ì™„ë£Œ í›„ì—ëŠ” ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                <li>3,000ë§ˆì¼ ì´ìƒ í›„ì› ì‹œ ê°ì‚¬ ë©”ì‹œì§€ë¥¼ ë‚¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                <li>í›„ì› ë‚´ì—­ì€ ë§ˆì´í˜ì´ì§€ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            </ul>
        </div>
    </div>
</div>

<script th:inline="javascript">
/*<![CDATA[*/
const lectureData = /*[[${lecture}]]*/ null;
const maxMiles = /*[[${userMiles}]]*/ 0;
let currentAmount = 0;  // ì´ˆê¸°ê°’ì„ ì„¤ì •í•´ì¤ë‹ˆë‹¤.
/*]]>*/





function updateAmount() {
    const input = document.getElementById('amountInput');
    const value = parseInt(input.value) || 0;
    currentAmount = value;
    validateAmount();
    updateMessageSection();
    updateSponsorshipButton();
    updatePresetButtons();
}

function validateAmount() {
    const group = document.getElementById('amountInputGroup');
    const error = document.getElementById('errorMessage');
    if (currentAmount < 100 || currentAmount > maxMiles) {
        group.classList.add('error');
        error.classList.add('show');
        return false;
    } else {
        group.classList.remove('error');
        error.classList.remove('show');
        return true;
    }
}

function setAmount(amount) {
    if (amount === 'ì „ì•¡') {
        amount = maxMiles;
    }
    document.getElementById('amountInput').value = amount;
    updateAmount();
}

function increaseAmount() {
    setAmount(Math.min(currentAmount + 1000, maxMiles));
}

function decreaseAmount() {
    setAmount(Math.max(currentAmount - 1000, 0));
}

function updatePresetButtons() {
    const presetButtons = document.querySelectorAll('.preset-btn');
    presetButtons.forEach(btn => {
        btn.classList.remove('active');
        const btnAmount = parseInt(btn.textContent.replace(',', '').replace('ì „ì•¡', maxMiles));
        if (btnAmount === currentAmount) {
            btn.classList.add('active');
        }
    });
}

function updateMessageSection() {
    const section = document.getElementById('messageSection');
    const textarea = document.getElementById('messageTextarea');
    const info = document.getElementById('messageInfo');
    if (currentAmount >= 3000) {
        section.classList.add('enabled');
        textarea.disabled = false;
        info.style.display = 'none';
        messageEnabled = true;
    } else {
        section.classList.remove('enabled');
        textarea.disabled = true;
        textarea.value = '';
        info.style.display = 'block';
        messageEnabled = false;
    }
    updateMessageCounter();
}

function updateMessageCounter() {
    document.getElementById('messageCount').textContent =
        document.getElementById('messageTextarea').value.length;
}

function updateSponsorshipButton() {
    const btn = document.getElementById('sponsorshipBtn');
    const text = document.getElementById('sponsorshipBtnText');
    const valid = currentAmount >= 100 && currentAmount <= maxMiles;
    btn.disabled = !valid;
    text.textContent = valid ? `${currentAmount.toLocaleString()}ë§ˆì¼ í›„ì›í•˜ê¸°` : 'í›„ì›í•˜ê¸°';
}

async function processSponsor() {
    if (!validateAmount()) return;

    const message = messageEnabled ? document.getElementById('messageTextarea').value : '';
    if (!confirm(`ê°•ì‚¬: ${lectureData.instructorNickname}\ní›„ì›: ${currentAmount.toLocaleString()}ë§ˆì¼\n\ní›„ì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    const btn = document.getElementById('sponsorshipBtn');
    const text = document.getElementById('sponsorshipBtnText');
    btn.disabled = true;
    text.textContent = 'í›„ì› ì¤‘...';

    try {
        const res = await fetch('/api/donation', {
            method: 'post',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                lectureNo: lectureData.courseSeq,
                amount: currentAmount,
                message: message
            })
        });
        
        if (res.ok) {
            const result = await res.json();
            alert('í›„ì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            
            // ì„±ê³µ í˜ì´ì§€ë¡œ ì´ë™í•  URL ìƒì„±
            const successUrl = new URL('/donation/success', window.location.origin);
            successUrl.searchParams.append('lectureTitle', result.lectureTitle);
            successUrl.searchParams.append('instructorName', result.instructorName);
            successUrl.searchParams.append('amount', result.amount);
            if (result.message) {
                successUrl.searchParams.append('message', result.message);
            }
            
            window.location.href = successUrl.href;
        } else {
            const result = await res.json();
            alert(result.message || 'í›„ì› ì‹¤íŒ¨');
            btn.disabled = false;
            updateSponsorshipButton();
        }
    } catch (e) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        btn.disabled = false;
        updateSponsorshipButton();
    }
}

function closeModal() {
    if (currentAmount > 0) {
        if (confirm('ì‘ì„± ì¤‘ì¸ í›„ì› ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ë‹«ì„ê¹Œìš”?')) window.history.back();
    } else {
        window.history.back();
    }
}

function chargeMiles() {
    const result = confirm('ë§ˆì¼ì„ ì¶©ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
    if (result) {
        // í™•ì¸ì„ ëˆ„ë¥¸ ê²½ìš°
        // URLì—ì„œ lectureNo íŒŒë¼ë¯¸í„° ê°’ì„ ì¶”ì¶œ
        const urlParams = new URLSearchParams(window.location.search);
        const lectureNo = urlParams.get('lectureNo');

        if (lectureNo) {
            // ì„¸ì…˜ì— lectureNo ê°’ ì €ì¥
            sessionStorage.setItem('lectureNo', lectureNo);
            
            // ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = '/user/payments?lectureNo=' + lectureNo;
        } else {
            alert("ê°•ì˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }
    // ì·¨ì†Œë¥¼ ëˆ„ë¥´ë©´ ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•ŠìŒ
}



// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    updateSponsorshipButton();
});
</script>
</body>
</html>
