<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <!-- Chart.js ì „ì—­ ë¡œë“œ -->
  <script src="/js/chart.umd.js"></script>
  <!-- drawCharts í•¨ìˆ˜ ì •ì˜ íŒŒì¼ -->
  <script src="/js/dashboardCharts.js"></script>
  
   <script th:src="@{/js/login-status.js}"></script>

  <!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="	https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"  rel="stylesheet"/>
  <link rel="stylesheet" th:href="@{/css/common.css}">
  <link rel="stylesheet" th:href="@{/css/course_list.css}">

  <!-- ë§ˆì´í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" th:href="@{/css/mypage.css}">
  <link rel="stylesheet" th:href="@{/css/lecture.css}">
  <link rel="stylesheet" th:href="@{/css/subscription.css}">
  
  
  <meta charset="UTF-8">
  <title>ë§ˆì´í˜ì´ì§€</title>
  <script>
    // ğŸ¯ ì½˜í…ì¸  ì˜ì—­ ë¹„ë™ê¸° ë¡œë“œ
    function loadContent(url) {
      fetch(url)
        .then(res => res.text())
        .then(html => {
          document.querySelector("#content-area").innerHTML = html;
          history.replaceState(null, '', '/mypage?tab=' + url.split('/').pop());

          if (url.includes("dashboard") && typeof window.drawCharts === 'function') {
            setTimeout(() => window.drawCharts(), 50);
          }
        })
        .catch(err => console.error("ë‚´ìš© ë¡œë“œ ì‹¤íŒ¨:", err));
    }


  function initSidebarClick() {
    document.querySelector(".sidebar").addEventListener("click", function (e) {
      const target = e.target.closest("a");
      if (!target) return;

      const href = target.getAttribute("href");
      // /mypage ë˜ëŠ” /mypage?tab=xxx ê¹Œì§€ í¬í•¨í•˜ë„ë¡ ì¡°ê±´ ë„“íˆê¸°
      if (href.startsWith("/mypage")) {
        e.preventDefault();

        // ì¿¼ë¦¬íŒŒë¼ë¯¸í„°ì—ì„œ tab ì¶”ì¶œ
        const urlObj = new URL(href, window.location.origin);
        const tabParam = urlObj.searchParams.get("tab") || urlObj.pathname.split("/").pop();

        // íŒ¨ìŠ¤ ë°©ì‹(/mypage/subscriptions)ì„ AJAXë¡œ í˜¸ì¶œ
        loadContent("/mypage/" + tabParam);
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    // ì´ˆê¸° ë¡œë“œ ì‹œì—ë„ query string ê¸°ì¤€ìœ¼ë¡œ tab ë½‘ì•„ì„œ path í˜¸ì¶œ
    const initialTab = new URL(window.location.href).searchParams.get("tab") || "dashboard";
    loadContent("/mypage/" + initialTab);
    initSidebarClick();
  });
    
    
    

    function uploadProfile() {
      const file = document.getElementById("profileFile").files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("file", file);

      fetch("/mypage/upload_profile", {
        method: "POST",
        body: formData
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.success) {
          document.getElementById("profilePreview").src = data.newPath + "?t=" + new Date().getTime();
          alert("í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + data.message);
        }
      })
      .catch(err => alert("ì—ëŸ¬ ë°œìƒ: " + err));
    }

 	 function unsubscribe(followingId) {
      fetch('/mypage/unsubscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'following_id=' + followingId
      })
      .then(res => {
        if (res.ok) {
          alert('êµ¬ë… ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          location.reload();
        } else {
          alert('ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });
      
    }
  </script>
  <style>
body.logged-in .guest-state {
  display: none;
}
body.logged-in .user-state {
  display: inline-flex ;
}
body.logged-out .guest-state {
  display: inline-flex ;
}
body.logged-out .user-state {
  display: none ;
}


</style>
</head>

<!--  í´ë˜ìŠ¤ ì¶”ê°€ -->
<body class="mypage">
  <div class="container">
    <!-- í—¤ë” Fragment -->
    <th:block th:replace="~{layout/header :: header}"/>

    <div class="main-content">
      <!-- ì‚¬ì´ë“œë°” Fragment -->
      <div class="sidebar" th:replace="~{mypage/sidebar :: sidebar}"></div>

      <!-- ë™ì  ì½˜í…ì¸  ì˜ì—­ -->
      <div class="content-area" id="content-area"></div>
    </div>
  </div>
</body>
<script th:src="@{/js/donation.js}"></script>
</html>
